---
isOriginal: true
icon: debug
date: 2023-05-25
category:
  - 技债
---

# C004.23届0525怪

## 1.CompanyManageController.java 70-74

gigax 6697d36f75f4ced94545489e61f8c3781ccf5ecd

```java
@RequestMapping("/admin/parcel/company-name.json")
public R<?> searchCompanyName() {
    Map<Long, String> map = companySearchService.searchName(TenantUtil.getTenantable());
    return R.okData(map);
}
// 修改后
@PostMapping("/admin/parcel/company-name.json")
public R<Map<Long, String>> searchCompanyName() {
    final Map<Long, String> map = companySearchService.searchName(TenantUtil.getTenantable());
    return R.okData(map);
}
```

### 明确请求 PostMapping

RequestMapping包括了 Get, Post, Put, Delete, Patch，对Swagger文档不友好，也容易造成乱用。
按wings的RestHalf约定，除了资源类和Oauht使用GET外，全部使用Post。

### 明确返回值 R的泛型

明确R的泛型，有利于Swagger自动推导response的示例，所以应该避免`R<?>`，一般呈现以下形式。

* `R<Void>` - 无data，可以返回`R.OK`
* `R<DataType>` - 明确的data类型
* `PageResult<DataType>` - 分页的，明确的Data类型

## 2.CompanyManageController.java 101-110

gigax 6697d36f75f4ced94545489e61f8c3781ccf5ecd

```java
@RequestMapping(value = "/admin/company/delete.json")
public R<?> deleteInfo(@RequestParam(value = "userId") long userId) {
    try {
        companySearchService.deleteCustomer(userId);
        return R.ok("删除成功！");
    }
    catch (Exception e) {
        log.error("/admin/company/delete.json", e);
        return R.ng("删除失败！");
    }
}
```

### 统一处理异常

没有必要在Controller中处理通用异常，交给HandlerExceptionResolver统一处理。

* CodeException - 默认无栈异常，属正常业务流，自动转换I18n
* Default - 默认处理未识别异常为预设的得response

## 3.DashboardController.java 56-59

gigax 6697d36f75f4ced94545489e61f8c3781ccf5ecd

```java
@PostMapping(value = "/dashboard/out/export.json")
@DoubleKill
public void export(@RequestBody DashboardService.QueryDate queryDate, HttpServletResponse response)
```

### DoubleKill的使用注意Key

DoubleKill基于AOP，建议使用SpEL指定key，否则方法的参数需要正确实现equals, hashCode，才能正确获取锁。

## 4.DashboardServiceImpl.java 332-337

gigax 6697d36f75f4ced94545489e61f8c3781ccf5ecd

```java
private void export(List<ExcelInfo> excelInfos) throws IOException {
    ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
    assert servletRequestAttributes != null;
    HttpServletResponse response = servletRequestAttributes.getResponse();
    assert response != null;
    EasyExcel.write(response.getOutputStream(), ExcelInfo.class)

// 修改后
private void export(@NotNull List<ExcelInfo> excelInfos, @NotNull OutputStream output) throws IOException {
    EasyExcel.write(routput, ExcelInfo.class)
```

### 严禁跨层，严禁隐式传值

* Web层对象不可以进入Service层，违反基本约定。
* 从ContextHolder取值属于方法泄露，违反基本约定。
* assert 改为前置检查，以CodeException中断处理。
* @NotNull 提供IDE检查，在编写时提供质量。
